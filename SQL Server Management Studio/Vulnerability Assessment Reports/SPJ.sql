

--创建表S
CREATE TABLE S
(
SNO INT NOT NULL,
SNAME CHAR(10) NOT NULL,
[STATUS] INT NOT NULL,
CITY CHAR(10) NOT NULL
);
--创建表P
CREATE TABLE P
(
PNO INT  NOT NULL,
PNAME CHAR(20)NOT NULL,
COLOR CHAR(4) NOT NULL,
[WEIGHT] INT NOT NULL
);
--创建表J
CREATE TABLE J
(
JNO INT NOT NULL,
JNAME CHAR(10)NOT NULL,
CITY CHAR(10) NOT NULL
);
--创建表SPJ
CREATE TABLE SPJ
(
SNO  INT NOT NULL,
PNO INT NOT NULL,
JNO INT NOT NULL,
QTY INT NOT NULL
);



--(3)在前三个表上建立对编码的索引，索引名分别为S_Idx、P_Idx和J_Idx；
CREATE UNIQUE INDEX S_Idx ON S(SNO);
CREATE UNIQUE INDEX P_Idx ON P(PNO);
CREATE UNIQUE INDEX J_Idx ON J(JNO);

--(4)在SPJ表的字段SNo、PNo、JNo上建立名为SPJ_idx的索引；
CREATE UNIQUE INDEX SPJ_idx ON SPJ(SNO,PNO,JNO);

--(5)在SPJ表的字段SNo、PNo、JNo上建立外键约束（参照完整性）
alter table SPJ add constraint fk_SNO foreign key(SNO) references S(SNO);
alter table SPJ add constraint fk_PNO foreign key(PNO) references P(PNO);
alter table SPJ add constraint fk_JNO foreign key(JNO) references J(JNO);



--(6)在SSMS中将课本上四个表的数据输入到表中
--S表插入数据
INSERT INTO S
(SNO,SNAME,[STATUS] ,CITY )
VALUES
(1,'精益',20,'天津'),
(2,'盛锡',10,'北京'),
(3,'东方红',30,'北京'),
(4,'丰泰盛',20,'天津'),
(5,'为民',30,'上海');

--P表插入数据
INSERT INTO P(PNO,PNAME,COLOR,[WEIGHT])
VALUES 
(1,'螺母','红',12),
(2,'螺栓','绿',17),
(3,'螺丝刀','蓝',14),
(4,'螺丝刀','红',14),
(5,'凸轮','蓝',40),
(6,'齿轮','红',30);

--J表插入数据
INSERT INTO J(JNO ,JNAME ,CITY )
VALUES 
(1,'三建','北京'),
(2,'一汽','长春'),
(3,'弹簧厂','天津'),
(4,'造船厂','天津'),
(5,'机车厂','唐山'),
(6,'无线电厂','常州'),
(7,'半导体厂','南京');

--SPJ表插入数据
INSERT INTO SPJ(SNO ,PNO ,JNO,QTY)
VALUES
(1,1,1,200),
('1','1','3',100),
('1','1','4',700),
('1','2','2',100),
('2','3','1',400),
('2','3','2',200),
('2','3','4',500),
('2','3','5',400),
('2','5','1',400),
('2','5','2',100),
('3','1','1',200),
('3','3','1',200),
('4','5','1',100),
('4','6','3',300),
('4','6','4',200),
('5','2','4',100),
('5','3','1',200),
('5','6','2',200),
('5','6','4',500);

--(8)自行设计一种需求，完成对四个表中其中一个表的查询操作；










--（1）找出所有供应商的姓名和所在城市
SELECT SNAME,CITY
FROM S;

--（2）找出所有零件的名称、颜色、重量
SELECT PNAME,COLOR,WEIGHT
FROM P;

--（3）找出使用供应商S1所供应零件的工程号码
SELECT JNO
FROM SPJ
WHERE SNO='1';

--（4）找出工程项目J2使用的各种零件的名称及其数量
SELECT PNAME,QTY
FROM P,SPJ
WHERE P.PNO=SPJ.PNO AND SPJ.JNO='2';

--（5）找出上海厂商供应的所有零件号码
SELECT DISTINCT PNO
FROM SPJ
WHERE SNO IN
(SELECT SNO
FROM S
WHERE CITY='上海');

--（6）找出使用山海产的零件的工程名称
SELECT JNAME
FROM J
WHERE JNO IN
(SELECT JNO
FROM SPJ
WHERE SNO IN
(select SNO
FROM S
WHERE CITY='上海'));

--（7）找出没有使用天津产的零件的工程号码
SELECT DISTINCT JNO
FROM SPJ
WHERE SNO not IN
(SELECT SNO
FROM S
WHERE CITY='天津');

--（12）从基本表查询天津供应商的编号、姓名、状态和城市；
SELECT SNO ,SNAME,STATUS,CITY
FROM S
WHERE CITY='天津';

--(13)从基本表查询重量大于14的零件的名称、颜色和重量；
SELECT PNAME,COLOR,WEIGHT
FROM P
WHERE weight>14;

--(14)从基本表查询供应工程1零件1的供应商号码；
SELECT SNO
FROM SPJ
WHERE JNO='1' AND PNO='1';

--(15)从基本表查询供应数量大于200小于等于400的供应商姓名；
SELECT SNAME
FROM S
WHERE SNO IN
(SELECT SNO
FROM SPJ
WHERE QTY >200 AND QTY<=400);


--(16)从基本表查询没有使用天津供应商生产的红色零件的工程号；

USE SPJ
GO
SELECT DISTINCT JNO 
FROM SPJ
WHERE JNO NOT IN 
(SELECT JNO 
FROM S,SPJ ,P
WHERE S.SNO=SPJ.SNO AND P.PNO=SPJ.PNO AND COLOR='红' AND CITY='天津');
GO

--(17)从基本表查询所供应零件数量大于等于300的供应商编号；
SELECT DISTINCT SNO 
FROM SPJ
WHERE QTY>=300;



--(19)计算每个各供应商供应零件的总数量。
SELECT SUM(QTY) AS ZONGSHULIANG
FROM SPJ 
GROUP BY SNO;

--3.自行设计一种需求，完成一个涉及到三个表的查询操作
--1、查询使用产地是精益的零件的工程名
SELECT JNAME 
FROM J 
WHERE JNO IN 
(SELECT JNO 
FROM S,SPJ ,P
WHERE S.SNO=SPJ.SNO AND J.JNO=SPJ.JNO AND SNAME ='精益');










--把全部红色零件的颜色改成蓝色
update P
set COLOR='蓝'
where COLOR='红'

--由S5供给J4的零件P6改为由S3供应，请作必要的修改
update SPJ
set SNO='3'
where SNO='5' and PNO='6' and JNO='4'

--从供应商关系中删除S2的记录，并从供应情况关系中删除相应的记录
delete
from S
where SNO='2'
delete
from SPJ
where SNO='2'

--请将 (2, 6, 4, 200) 插入供应情况关系
insert 
into SPJ(SNO,PNO,JNO,QTY)
values(2,6,4,200)

--建立视图
CREATE VIEW SPJ_View
AS 
SELECT SNO,PNO,QTY
FROM J,SPJ
WHERE JNAME='三建' and SPJ.JNO=J.JNO

--各种零件代码及其数量
select PNO,sum(QTY) as number
from SPJ_View
group by PNO

--供应商1的供应情况
select distinct*
from SPJ_View
where SNO='1'

--自行设计一种需求，完成一个涉及到三个表的视图定义与查询操作
--1、建立供给螺栓的工程项目名
create view V_SPJ
as 
select JNAME ,CITY
from J
where JNO in(
select distinct JNO
from P,SPJ
where PNAME='螺母' and P.PNO=SPJ.PNO
);
---删除视图
DROP VIEW V_SPJ;
--查询工程项目所在地
select CITY 
from V_SPJ
